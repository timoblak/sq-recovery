import numpy as np
from matplotlib import pyplot as plt
import open3d as o3d
from mpl_toolkits.mplot3d import Axes3D
from time import time, sleep
from quaternion import rotate, mat_from_quaternion_np, conjugate_np, multiply_np, to_magnitude_np, conjugate, multiply, to_magnitude
from helpers import plot_render, plot_grad_flow, plot_points, norm_img, randquat, slerp, quat2mat, get_command
from classes import ChamferQuatLoss, IoUAccuracy, ChamferLoss, LeastSquares, DifferentialRenderLoss
import torch
from sklearn.preprocessing import normalize
import cv2
import os


def sample_points_uniform(parameters, rad_resolution=0.5):
    a1, a2, a3 = parameters[:3]
    e1, e2 = parameters[3:5]

    theta, gamma = np.arange(-np.pi, np.pi, rad_resolution), np.arange(-np.pi / 2, np.pi / 2, rad_resolution)
    w, h = len(theta), len(gamma)

    pts = np.zeros(shape=(h * w, 3))
    cg = np.cos(gamma)
    sg = np.sin(gamma)

    iter = 0
    for t in theta:
        pts[iter * h:(iter + 1) * h, 0] = a1 * np.sign(cg * np.cos(t)) * (np.abs(cg) ** e1) * (np.abs(np.cos(t)) ** e2)
        pts[iter * h:(iter + 1) * h, 1] = a2 * np.sign(cg * np.sin(t)) * (np.abs(cg) ** e1) * (np.abs(np.sin(t)) ** e2)
        pts[iter * h:(iter + 1) * h, 2] = a3 * np.sign(sg) * (np.abs(sg) ** e1)
        iter += 1
    return pts

def quaternion_diffs(q):

    quat_diffs = []
    quat_diffs.append(q[0])
    for qi in range(1, len(q)):

        app = multiply_np(q[qi], conjugate_np(q[qi-1]))
        quat_diffs.append(app)

    quat_diffs.append(conjugate_np(q[-1]))
    return np.stack(quat_diffs)


def init_visualization():
    vis = o3d.visualization.Visualizer()
    vis.create_window(window_name="Visu", width=800, height=600)
    opt = vis.get_render_option()
    opt.mesh_show_back_face = True
    return vis


def randsq():

    return np.concatenate((np.random.uniform(0.1, 0.3, (3,)), np.random.uniform(0.1, 1, (2,)), np.random.uniform(0.34, 0.65, (3,))))

if __name__ == "__main__":
    device = torch.device("cuda:0")
    req_grad = False

    fourcc = cv2.VideoWriter_fourcc(*'MP4V')
    #out = cv2.VideoWriter('output.mp4', fourcc, 30.0, (800, 600))

    granularity = 32
    #loss = ChamferQuatLoss(render_size=granularity, device=device)

    #loss = RealChamferLoss(render_size=granularity, device=device)
    sharpness = 260
    tau = 1.5
    #loss = DifferentialRenderLoss(render_size=64, device=device, tau=tau, sigmoid_sharpness=sharpness)
    loss = ChamferLoss(render_size=granularity, device=device)
    acc = IoUAccuracy(render_size=128, device=device, full=True)

    torch.autograd.set_detect_anomaly(True)

    # 54% partial view
    #true_parameters = np.array([0.1916242,   0.12128632,  0.28911042,  0.220042,    0.251029,    0.6483096, 0.64661086,  0.4409428, 0.520819,    0.482072,   -0.519715,    0.475658])
    #pred_parameters = np.array([0.29098943,  0.11994522,  0.11140418,  0.31691232,  0.22922292,  0.64910042, 0.64636648,  0.51784301, 0.73983002,  0.67108256, -0.01888049, -0.04408219])

    ## SUPERVISED
    # 52%
    #true_parameters = np.array([0.24433598, 0.15345776, 0.10019663, 0.992789,   0.420442,   0.40605044, 0.36008492, 0.56295735, 0.687106,   0.228554,   0.527723,   0.444024  ])
    #pred_parameters = np.array([0.16088201,  0.15704669,  0.1592053,   0.82681698,  0.75441051,  0.40766987, 0.36223733,  0.56045634,  0.54089814,  0.7905671,   0.27504858, -0.08234798])
    # 57
    #true_parameters = np.array([0.11648749,  0.29305872,  0.20009805,  0.695907,    0.29304,     0.534567, 0.48142296,  0.6410554, - 0.838082, - 0.10417,     0.532941,    0.052351])
    #pred_parameters = np.array([0.23240924,    0.18620045,    0.17401996,   0.6813513,    0.61728084,    0.53470939,    0.48429927,    0.64241272,    0.60968786,    0.69395286,    0.37678069, -0.06889556])
    # 59
    #true_parameters = np.array([0.1001478,   0.25355858,  0.23794457,  0.791787,    0.840822,    0.5773047, 0.60817176,  0.38153443, - 0.297742, - 0.581158, - 0.6055,      0.454944])
    #pred_parameters = np.array([0.1791048,    0.26636887,    0.1358511,    0.83285904,    0.88724935,    0.5767464,    0.60819674,    0.38229755,    0.43268088,    0.82076579,    0.36894253, - 0.05488338])


    # acc: 0.5490335417851052
    #true_parameters = np.array([0.1916242, 0.12128632, 0.28911042, 0.220042, 0.251029, 0.6483096,0.64661086, 0.4409428, 0.520819, 0.482072, -0.519715, 0.475658])
    #pred_parameters = np.array([0.29098943, 0.11994522, 0.11140418, 0.31691232, 0.22922292, 0.64910042,0.64636648, 0.51784301, 0.73983002, 0.67108256, -0.01888049, -0.04408219])

    # 6182
    #true_parameters = np.array([0.24023579, 0.27912527, 0.12937327, 0.846349, 0.35903, 0.6033021, 0.6130329, 0.552188, 0.487947, -0.785237, -0.130427, -0.358189])
    #pred_parameters = np.array([     0.17401893, 0.18007199, 0.27146176, 0.52093512, 0.84759307, 0.60348815,    0.61348313, 0.55074567, 0.19726224, 0.72392738, 0.10409053, -0.65282595])

    # 6883
    #true_parameters = np.array([0.28587958, 0.28547037, 0.26232594, 0.577279, 0.260008, 0.40011382, 0.47980547, 0.40746638, 0.653294, 0.275704, 0.650607, -0.271855])
    #pred_parameters = np.array([       0.21638724, 0.25486758, 0.28678086, 0.40951771, 0.67503345, 0.39912567,       0.48071155, 0.48466438, 0.27591145, 0.6524635, 0.26212889, -0.65532637])

    # acc: 0.7847876225254661
    #true_parameters = np.array([0.135468, 0.16105953, 0.12997328, 0.810339, 0.226866, 0.6532027,0.46003315, 0.6519532, -0.69553, -0.713961, 0.054647, -0.059253])
    #pred_parameters = np.array([0.13907774, 0.16205926, 0.13704392, 0.57920504, 0.41792846, 0.65559441,0.45973006, 0.63578087, 0.49829829, 0.51692903, 0.47633511, -0.50753146])

    # acc: 0.9180120735645093
    #true_parameters = np.array([0.277212, 0.1922571, 0.25946477, 0.763927, 0.168626, 0.54808694,0.5131273, 0.46555805, -0.803472, 0.263101, -0.532034, -0.046371])
    #pred_parameters = np.array([0.24488008, 0.19396283, 0.27521262, 0.43519941, 0.66824281, 0.54738832,0.5136013, 0.46535194, 0.21319094, 0.94633192, 0.15560691, -0.18652645])

    # acc: 0.9798033235824983
    #true_parameters = np.array([0.13991985, 0.23776954, 0.1401938, 0.495047, 0.411227, 0.3832906,0.5774043, 0.55826116, 0.182195, -0.4016, 0.893597, 0.083706])
    #pred_parameters = np.array([0.1396701, 0.23614413, 0.14018483, 0.47859192, 0.37988371, 0.38435712,0.57825559, 0.55838174, 0.07428057, 0.89123517, 0.40475395, -0.19067352])

    ## UNSUPERVISED
    # least squares
    # 2184
    #true_parameters = np.array([2.4970385e-01, 2.5004882e-01, 1.0312483e-01, 9.7392398e-01,                                1.2586699e-01, 6.1938465e-01, 3.7952244e-01, 6.5295708e-01,                                6.0099998e-04, 1.9220000e-02, -9.5545697e-01, 2.9450199e-01])
    #pred_parameters = np.array([0.26383978, 0.30760986, 0.25743157, 0.26744682, 0.37740216, 0.61477941,                                0.39357135, 0.43041086, 0.70590132, 0.19855925, 0.19638181, 0.65093136])

    # acc: 0.34885161393448355
    #true_parameters = np.array([0.11535955, 0.23518118, 0.25784084, 0.693787, 0.981077, 0.38695815,0.47545, 0.45904642, -0.361121, 0.671882, 0.231381, 0.603845])
    #pred_parameters = np.array([0.2607404, 0.25268465, 0.23455819, 0.58405322, 0.48653468, 0.38832733, 0.444599, 0.3186872, 0.5783323, 0.35109657, 0.26348138, 0.68763399])

    # acc: 0.430888470681458
    #true_parameters = np.array([0.11028407, 0.15553814, 0.21706611, 0.881934, 0.795877, 0.6463695,0.6461635, 0.64048684, -0.594434, 0.481933, 0.394736, 0.5085])
    #pred_parameters = np.array([0.15155666, 0.19686067, 0.20310967, 0.5149551, 0.55876178, 0.65417308,0.62701762, 0.54633802, 0.65455073, -0.03083623, 0.02900858, 0.75483173])

    # acc: 0.5502989631702818
    #true_parameters = np.array([0.0997627, 0.11955843, 0.23422015, 0.249966, 0.824376, 0.4983768,0.426335, 0.48228234, -0.082265, -0.534922, 0.828977, 0.141027])
    #pred_parameters = np.array([0.0995807, 0.18703793, 0.22730324, 0.21085966, 0.60420579, 0.48098674,0.39013407, 0.42206144, 0.54985595, -0.08192916, -0.16923928, 0.81382066])

    # acc: 0.641189071498806
    #true_parameters = np.array([0.1848979, 0.13974574, 0.11622144, 0.10747, 0.963616, 0.37376052,0.3920682, 0.5760466, -0.01849, -0.569692, -0.722884, 0.390574])
    #pred_parameters = np.array([0.17997672, 0.18369254, 0.12170409, 0.26197383, 0.7280997, 0.34625679,0.3961322, 0.52964467, 0.76703465, 0.3188006, 0.04523979, 0.55495715])

    # acc: 0.749838343819602
    #true_parameters = np.array([0.28406733, 0.24348503, 0.25570896, 0.100491, 0.758437, 0.47499996,0.60729104, 0.6572592, 0.129931, 0.623535, 0.400055, -0.658998])
    #pred_parameters = np.array([0.23873545, 0.3244783, 0.24045132, 0.15509671, 0.6713317, 0.46128753,0.62026924, 0.60490257, 0.73807788, 0.27057374, 0.26238051, 0.55963135])

    # acc: 0.859900622019114
    #true_parameters = np.array([0.22185189, 0.26607138, 0.18225636, 0.810628, 0.852571, 0.448954,0.46640715, 0.40638193, 0.225228, 0.565352, -0.729082, -0.313192])
    #pred_parameters = np.array([0.17477132, 0.2411122, 0.2164311, 0.79269385, 0.77290434, 0.44308868,0.46943346, 0.42562184, 0.65087968, 0.40664858, 0.14781581, 0.62381333])

    # acc: 0.951190693172605
    #true_parameters = np.array([0.24093094, 0.2174208, 0.19790623, 0.350751, 0.268504, 0.5437671,0.55312127, 0.5223381, -0.577423, 0.517337, -0.046821, -0.629884])
    #pred_parameters = np.array([0.20206065, 0.21740732, 0.23832235, 0.30163735, 0.32648745, 0.54382282,0.55403101, 0.51804936, 0.38567737, 0.07337942, 0.42987549, 0.81306547])

    # differentiable
    # acc: 0.44178434706174896
    #true_parameters = np.array([0.29347426, 0.0996399, 0.10112411, 0.498286, 0.211221, 0.39443675,0.61887497, 0.6568745, 0.30883, 0.872645, 0.30268, -0.226934])
    #pred_parameters = np.array([0.28284767, 0.11388944, 0.2035538, 0.55015504, 0.58975583, 0.39907229,0.61544549, 0.60993981, -0.45014539, 0.16166008, -0.85107136, -0.2165935])
    # acc: 0.5455889672942348
    #true_parameters = np.array([0.11312747, 0.25664258, 0.2536905, 0.47988, 0.816874, 0.4397057,0.5925597, 0.5103449, 0.045521, -0.379084, -0.01837, 0.924059])
    #pred_parameters = np.array([0.20440795, 0.2613402, 0.20589684, 0.75894332, 0.68014652, 0.4431898,0.58887666, 0.4858852, -0.61612505, 0.02397957, -0.78157187, 0.09465864])
    # acc: 0.6526584317937701
    #true_parameters = np.array([0.2684528, 0.17184755, 0.12241526, 0.417121, 0.163526, 0.43800855,0.34648353, 0.5601015, -0.324961, 0.247949, -0.572851, 0.710467])
    #pred_parameters = np.array([0.11099649, 0.27366164, 0.17716511, 0.46146923, 0.21706349, 0.44325855,0.34049132, 0.57761586, -0.72398317, -0.08995297, -0.67840999, 0.0866988])
    ## acc: 0.7511540790071136
    #true_parameters = np.array([0.20930253, 0.14899802, 0.10589021, 0.307226, 0.95028, 0.57223797,0.4754797, 0.5611348, 0.728278, 0.549783, 0.395788, -0.103451])
    #pred_parameters = np.array([0.21713172, 0.13670474, 0.15692101, 0.84145492, 0.509453, 0.58128589,0.46900791, 0.55039465, -0.61236942, -0.02800186, -0.6679846, -0.42191967])
    # acc: 0.8563442253648467
    true_parameters = np.array([0.17840092, 0.29169756, 0.19272356, 0.564326, 0.850042, 0.5160052,0.51887995, 0.41229093, 0.468217, 0.567843, -0.355409, 0.576204])
    #pred_parameters = np.array([0.19590288, 0.29424879, 0.1956858, 0.59973598, 0.79554117, 0.52428204,0.51193249, 0.40122905, -0.56326938, 0.44378394, -0.57923102, -0.3876529])
    # acc: 0.9365994718015579
    #true_parameters = np.array([0.277212, 0.1922571, 0.25946477, 0.763927, 0.168626, 0.54808694,0.5131273, 0.46555805, -0.803472, 0.263101, -0.532034, -0.046371])
    #pred_parameters = np.array([0.28595215, 0.19695245, 0.26402789, 0.83596718, 0.22228831, 0.55584484,0.50598204, 0.46726972, -0.80634487, 0.26864406, -0.52515328, -0.04303975])

    #true_parameters = np.array([0.277212, 0.1922571, 0.25946477, 0.168626, 0.763927, 0.54808694, 0.5131273, 0.46555805, -0.803472, 0.263101, -0.532034, -0.046371])
    #pred_parameters = np.array([0.50123,  0.511,  0.5003,  0.492,  0.500,  0.5107,  0.5011,  0.4942,  -0.4920,  0.5146, -0.4878,  0.5107])

    pred_parameters = np.concatenate([randsq(), randquat()])

    q_true = true_parameters[8:] #np.array([-0.53357057, -0.02723011, -0.14769082,  0.83231508])

    # Good: np.array([-0.24230276, 0.06868397, 0.94660542, -0.20127114])
    q_pred = pred_parameters[8:]

    # Create SQ pointcloud
    #params = [0.23, 0.11, 0.29, 0.1, 0.1]
    params_true = true_parameters[:8]
    params_pred = pred_parameters[:8]

    M = quat2mat(q_true[-4:])
    params = np.concatenate((params_true[:3] * 255., params_true[3:5], params_true[5:8] * 255, M.ravel()))
    command = get_command("../", "visu_true.bmp", params)
    os.system(command)

    img = cv2.imread("visu_true.bmp", 0)/255
    true_img = torch.from_numpy(img).to(device)
    true_img = true_img.unsqueeze(0).unsqueeze(0)

    pts = sample_points_uniform(params_true, rad_resolution=0.1)
    pcd = o3d.geometry.PointCloud()
    pcd.points = o3d.utility.Vector3dVector(pts)
    # Create convex hull
    hull, _ = pcd.compute_convex_hull()
    hull.compute_vertex_normals()

    # Line mesh for true quadric
    hull_ls1 = o3d.geometry.LineSet.create_from_triangle_mesh(hull)
    hull_ls1.paint_uniform_color((1, 0, 0))


    mat_transform_true = np.eye(4)
    mat_transform_true[:3, :3] = mat_from_quaternion_np(q_true)[0]
    mat_transform_true[:3, 3] = params_true[5:8]

    hull_ls1.transform(mat_transform_true)

    debug = False
    if not debug:
        vis = init_visualization()
        vis.add_geometry(hull_ls1)
        ctr = vis.get_view_control()
        parameters = o3d.io.read_pinhole_camera_parameters("ScreenCamera_2020-08-31-14-29-43.json")
        #ctr.convert_from_pinhole_camera_parameters(parameters)

    lr = 0.001
    i = 0
    while True:
        #ctr.convert_from_pinhole_camera_parameters(parameters)
        pts = sample_points_uniform(params_pred, rad_resolution=0.1)
        pcd = o3d.geometry.PointCloud()
        pcd.points = o3d.utility.Vector3dVector(pts)
        # Create convex hull
        hull_pred, _ = pcd.compute_convex_hull()
        hull_pred.compute_vertex_normals()
        if not debug:
            vis.add_geometry(hull_pred, reset_bounding_box=False)

        mat_q = mat_from_quaternion_np(q_pred)[0]

        #hull_pred.rotate(mat_q, [0, 0, 0])
        mat_transform = np.eye(4)
        mat_transform[:3, :3] = mat_q
        mat_transform[:3, 3] = params_pred[5:8]

        hull_pred.transform(mat_transform)
        true = torch.tensor(
            [
                np.concatenate([params_true, q_true])
            ], device='cuda:0')
            

        pred = torch.tensor(
            [
                #q_pred
                np.concatenate([params_pred, q_pred])
            ],
            device='cuda:0', requires_grad=True)

        #l = l_a + l_e + l_t + l_q

        l = loss(true, pred)
        #a = acc(true, pred[:, 8:])
        a = acc(true, pred)

        diff = to_magnitude(multiply(torch.from_numpy(q_true), conjugate(torch.from_numpy(q_pred))))
        loss_np = l.detach().cpu().item()
        acc_np = a.detach().cpu().item()

        l.backward()

        print("Iter", i)
        print("Predicted:", q_pred)
        print("Predicted:", normalize([q_pred]))
        print("True", q_true)
        print("Grads:", pred.grad)
        print("Loss:", loss_np)
        print("Accuracy:", acc_np)
        print("Angle difference:", diff)
        print("Lr:", lr)
        print("---------------------------------------")

        #if i > 3500:
        #    lr = 0.005
        #if i > 10000:
        #    lr = 0.001
        gradient = pred.grad.detach().cpu().numpy()[0]
        #exit()
        q_pred -= lr * gradient[8:]
        q_pred = normalize([q_pred])[0]

        params_pred -= lr * gradient[:8]

        if not debug:
            vis.update_geometry(hull_pred)
            vis.poll_events()
            vis.update_renderer()

        #if i < 100 and i % 10 == 0 or i % 100 == 0 :
        #    image = vis.capture_screen_float_buffer(False)
        #    plt.imsave("iteration_images/render_"+str(i)+".png", np.asarray(image), dpi=1)
        #img = np.asarray(vis.capture_screen_float_buffer(True))
        #img = cv2.cvtColor(img, cv2.COLOR_RGB2BGR)
        #img = (img * 255).astype('uint8')
        #out.write(img)
        #cv2.imshow("asdasd", img)
        #cv2.waitKey()


        sleep(0.0)
        #hull_pred.rotate(mat_q.T, [0, 0, 0])
        i+=1
        if not debug:
            vis.remove_geometry(hull_pred, reset_bounding_box=False)


    out.release()
    vis.destroy_window()

"""

tensor([[ 0.1166,  0.1219,  0.1367,  0.7549,  0.5152,  0.5910,  0.3958,  0.6315,
          0.4587, -0.8290,  0.2780,  0.1585],
        [ 0.1996,  0.2313,  0.1593,  0.1441,  0.5284,  0.6089,  0.4262,  0.4990,
         -0.0571, -0.5224, -0.7675, -0.3670],
        [ 0.1361,  0.1884,  0.1332,  0.4246,  0.5976,  0.4382,  0.4804,  0.5376,
          0.8509, -0.1591,  0.3079, -0.3948],
        [ 0.2459,  0.2737,  0.2902,  0.9892,  0.8445,  0.6455,  0.6013,  0.3996,
         -0.1203,  0.1149, -0.8852, -0.4345],
        [ 0.2554,  0.1024,  0.1243,  0.4442,  0.4847,  0.3753,  0.3542,  0.5288,
          0.1294,  0.7612, -0.4037, -0.4907],
        [ 0.1852,  0.2629,  0.1143,  0.8005,  0.9665,  0.4829,  0.4545,  0.5807,
          0.3983, -0.2366, -0.8171, -0.3431],
        [ 0.2660,  0.1470,  0.2511,  0.2668,  0.2718,  0.3558,  0.3467,  0.4545,
          0.1357,  0.3233, -0.8649, -0.3593],
        [ 0.1758,  0.2447,  0.1448,  0.1068,  0.3768,  0.6330,  0.4025,  0.5981,
          0.4034, -0.9041, -0.0815, -0.1145],
        [ 0.1334,  0.1594,  0.1117,  0.7234,  0.7051,  0.4303,  0.3712,  0.5394,
         -0.9855, -0.1327, -0.0569,  0.0895],
        [ 0.1205,  0.2326,  0.2777,  0.5483,  0.9702,  0.3524,  0.5263,  0.4284,
          0.3523, -0.1127, -0.3552, -0.8585],
        [ 0.2890,  0.2399,  0.2582,  0.8803,  0.4080,  0.4028,  0.4000,  0.3670,
         -0.0963,  0.3156,  0.9424,  0.0549],
        [ 0.1244,  0.1707,  0.2050,  0.5093,  0.2526,  0.5665,  0.4282,  0.5605,
          0.6121, -0.0320,  0.3257, -0.7199],
        [ 0.2130,  0.1083,  0.1996,  0.2209,  0.5531,  0.5501,  0.5381,  0.5670,
         -0.3280,  0.4695, -0.6633,  0.4818],
        [ 0.1998,  0.1674,  0.2467,  0.8034,  0.2889,  0.5178,  0.6429,  0.6091,
          0.0290, -0.7991,  0.5314, -0.2796],
        [ 0.1538,  0.2216,  0.1758,  0.9157,  0.8596,  0.3967,  0.4878,  0.6195,
          0.5293,  0.0706, -0.7950, -0.2878],
        [ 0.1271,  0.1388,  0.1781,  0.6055,  0.6471,  0.4492,  0.5019,  0.5206,
          0.5552, -0.4088, -0.3807, -0.6162],
        [ 0.2878,  0.2136,  0.2034,  0.7296,  0.8222,  0.5515,  0.3460,  0.3959,
          0.2475,  0.3209,  0.8976,  0.1736],
        [ 0.1693,  0.1401,  0.2480,  0.5930,  0.9853,  0.3543,  0.4828,  0.5380,
         -0.8285, -0.0754, -0.0749, -0.5498],
        [ 0.1535,  0.2843,  0.2577,  0.9704,  0.9133,  0.5776,  0.4093,  0.3733,
         -0.1003, -0.4884, -0.6963, -0.5164],
        [ 0.1168,  0.1042,  0.2698,  0.1223,  0.2900,  0.4281,  0.6561,  0.4106,
          0.2557,  0.4165, -0.8332, -0.2587],
        [ 0.2087,  0.2722,  0.2937,  0.1960,  0.9346,  0.6499,  0.4697,  0.6547,
         -0.4381, -0.1764,  0.8376, -0.2747],
        [ 0.2370,  0.2842,  0.2350,  0.5211,  0.7314,  0.3657,  0.6316,  0.3885,
         -0.2366, -0.4358, -0.3830,  0.7793],
        [ 0.1221,  0.2473,  0.2742,  0.8191,  0.4745,  0.5495,  0.6175,  0.5682,
         -0.5078, -0.0618, -0.8589, -0.0258],
        [ 0.2055,  0.1897,  0.2784,  0.5529,  0.8743,  0.5187,  0.6402,  0.5866,
          0.5061, -0.7978,  0.0086,  0.3275],
        [ 0.2589,  0.2107,  0.2886,  0.2819,  0.8018,  0.5727,  0.4977,  0.5167,
          0.1688, -0.4158,  0.0362,  0.8929],
        [ 0.2799,  0.1774,  0.1346,  0.8796,  0.9384,  0.6305,  0.5679,  0.3860,
         -0.2286,  0.8879, -0.3343, -0.2184],
        [ 0.2582,  0.1026,  0.2181,  0.4935,  0.6959,  0.6124,  0.3472,  0.4668,
          0.4542,  0.1331,  0.6144, -0.6312],
        [ 0.2634,  0.1360,  0.2881,  0.7654,  0.2847,  0.6367,  0.5711,  0.4283,
         -0.6848, -0.5008, -0.5269, -0.0502],
        [ 0.1064,  0.2766,  0.1063,  0.1339,  0.9209,  0.5230,  0.5823,  0.6049,
         -0.6852, -0.1264,  0.3632,  0.6186],
        [ 0.2823,  0.1928,  0.1359,  0.3902,  0.7718,  0.5545,  0.3924,  0.3647,
          0.2095, -0.1600, -0.8313,  0.4893],
        [ 0.1356,  0.2214,  0.1431,  0.7403,  0.8372,  0.4034,  0.4375,  0.5896,
         -0.7584, -0.0414, -0.6034, -0.2430],
        [ 0.2570,  0.2692,  0.2181,  0.5957,  0.5709,  0.5906,  0.4201,  0.4082,
          0.7313,  0.5486, -0.3786, -0.1445]], device='cuda:0')
tensor([[ 0.1630,  0.1170,  0.1343,  0.6863,  0.6626,  0.5960,  0.4090,  0.6172,
         -0.4237,  0.6347, -0.3787, -0.5236],
        [ 0.1917,  0.2286,  0.1711,  0.2439,  0.5095,  0.6019,  0.4181,  0.5152,
         -0.7787,  0.3488,  0.0312, -0.5205],
        [ 0.1293,  0.1235,  0.1828,  0.4384,  0.3096,  0.4346,  0.4808,  0.5618,
         -0.8571,  0.3437, -0.1400, -0.3572],
        [ 0.2592,  0.2608,  0.2323,  0.8135,  0.8656,  0.6431,  0.6031,  0.4286,
         -0.8127,  0.4474, -0.3436, -0.1458],
        [ 0.1531,  0.2296,  0.1248,  0.4013,  0.1570,  0.3599,  0.4024,  0.5185,
         -0.4208,  0.5940,  0.0135, -0.6855],
        [ 0.1987,  0.2375,  0.1179,  0.5858,  0.6243,  0.4729,  0.4545,  0.5758,
         -0.7421,  0.4574, -0.4521, -0.1888],
        [ 0.2624,  0.2540,  0.1852,  0.2622,  0.2963,  0.3386,  0.3398,  0.4476,
         -0.8438,  0.3232,  0.1379, -0.4056],
        [ 0.2566,  0.2324,  0.1855,  0.2029,  0.1093,  0.6408,  0.4319,  0.4983,
         -0.3603,  0.7097, -0.2401, -0.5557],
        [ 0.1639,  0.1353,  0.1494,  0.4947,  0.5564,  0.4326,  0.3827,  0.4977,
         -0.5882,  0.4781, -0.5506, -0.3498],
        [ 0.1519,  0.2057,  0.2480,  0.3223,  0.5185,  0.3922,  0.5507,  0.4446,
         -0.4215,  0.8022, -0.4022, -0.1307],
        [ 0.2337,  0.2768,  0.2423,  0.7401,  0.4105,  0.4054,  0.4052,  0.3858,
         -0.6201,  0.6997, -0.3093, -0.1740],
        [ 0.1210,  0.1677,  0.1872,  0.3454,  0.2310,  0.5654,  0.4316,  0.5811,
         -0.7153,  0.3179,  0.0071, -0.6223],
        [ 0.2184,  0.1870,  0.2020,  0.2726,  0.2964,  0.5651,  0.5283,  0.5028,
         -0.6453,  0.2344, -0.0224, -0.7267],
        [ 0.1901,  0.2181,  0.2076,  0.4778,  0.4167,  0.5146,  0.6539,  0.6032,
         -0.3854,  0.7534, -0.1189, -0.5194],
        [ 0.1909,  0.1615,  0.2119,  0.6875,  0.6855,  0.3861,  0.5104,  0.5994,
         -0.5495,  0.6275, -0.2012, -0.5137],
        [ 0.1729,  0.1322,  0.1732,  0.4193,  0.5756,  0.4634,  0.5046,  0.4908,
         -0.4382,  0.5721, -0.5471, -0.4259],
        [ 0.2239,  0.2710,  0.2052,  0.7652,  0.6803,  0.5463,  0.3632,  0.4036,
         -0.5316,  0.7329, -0.0942, -0.4139],
        [ 0.2065,  0.1659,  0.2329,  0.3605,  0.6712,  0.3505,  0.5146,  0.4863,
         -0.6230,  0.5484, -0.4425, -0.3395],
        [ 0.1456,  0.2459,  0.2273,  0.7667,  0.7134,  0.5705,  0.4229,  0.4159,
         -0.8172,  0.4838, -0.0928, -0.2992],
        [ 0.1174,  0.2648,  0.1561,  0.2703,  0.1541,  0.4152,  0.6272,  0.3920,
         -0.8950,  0.3129, -0.0259, -0.3168],
        [ 0.2603,  0.2921,  0.2661,  0.4779,  0.2944,  0.6103,  0.4599,  0.6307,
         -0.8729,  0.3918,  0.0788, -0.2799],
        [ 0.2762,  0.2781,  0.2288,  0.4289,  0.6837,  0.3454,  0.6506,  0.3698,
         -0.7695,  0.3812, -0.4475, -0.2495],
        [ 0.2332,  0.2448,  0.2165,  0.4134,  0.4686,  0.5900,  0.6019,  0.5035,
         -0.7365,  0.6298, -0.2319,  0.0842],
        [ 0.1957,  0.1801,  0.2783,  0.5315,  0.6489,  0.5190,  0.6397,  0.6006,
         -0.5024,  0.7965, -0.0535, -0.3320],
        [ 0.2499,  0.2885,  0.2022,  0.5052,  0.3483,  0.5616,  0.5026,  0.5365,
         -0.7641,  0.2749, -0.2994, -0.5010],
        [ 0.1688,  0.2537,  0.1379,  0.7182,  0.6605,  0.6098,  0.5630,  0.3986,
         -0.7925,  0.4795, -0.1291, -0.3540],
        [ 0.2642,  0.1096,  0.2140,  0.5459,  0.6507,  0.6209,  0.3557,  0.4677,
         -0.6275,  0.6159, -0.1721, -0.4442],
        [ 0.1646,  0.2522,  0.2490,  0.2561,  0.5137,  0.6093,  0.5871,  0.4333,
         -0.8367,  0.3655, -0.2208, -0.3430],
        [ 0.2428,  0.1152,  0.1397,  0.4883,  0.4749,  0.5474,  0.5982,  0.6099,
         -0.4195,  0.4782, -0.4393, -0.6343],
        [ 0.1848,  0.1716,  0.2682,  0.4392,  0.3136,  0.5784,  0.4008,  0.3472,
         -0.6743,  0.3131, -0.0589, -0.6662],
        [ 0.2163,  0.1408,  0.2062,  0.6765,  0.5591,  0.3840,  0.4244,  0.5450,
         -0.4820,  0.5742, -0.3126, -0.5833],
        [ 0.2500,  0.2579,  0.2323,  0.6857,  0.4722,  0.5751,  0.4233,  0.4227,
         -0.5385,  0.7467,  0.1290, -0.3685]], device='cuda:0',
       grad_fn=<CatBackward>)

"""